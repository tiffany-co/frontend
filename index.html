<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Shop</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Vazirmatn Font for Persian text -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@latest/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple transition for page visibility */
        .page {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom class to apply the Vazirmatn font */
        .font-vazir {
            font-family: 'Vazirmatn', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-md">
        <!-- Login Page -->
        <div id="login-page" class="page">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Welcome Back</h1>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., johndoe" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200">
                        Login
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                </form>
            </div>
        </div>

        <!-- User Details Page -->
        <div id="details-page" class="page hidden">
            <div class="bg-white p-8 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">User Profile</h1>
                    <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition duration-200">
                        Logout
                    </button>
                </div>
                <div id="user-details" class="space-y-4">
                    <!-- User details will be populated here by JavaScript -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500">Full Name</p>
                        <p id="user-full-name" class="font-semibold text-gray-900"></p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500">Username</p>
                        <p id="user-username" class="font-semibold text-gray-900"></p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500">Phone Number</p>
                        <p id="user-phone" class="font-semibold text-gray-900"></p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500">Role</p>
                        <p id="user-role" class="font-semibold text-gray-900 capitalize"></p>
                    </div>
                     <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500">Status</p>
                        <p id="user-status" class="font-semibold text-gray-900"></p>
                    </div>
                </div>
                 <p class="text-center text-gray-600 mt-8 font-vazir" dir="rtl">
                    اپلیکیشن در حال توسعه می باشد.
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const detailsPage = document.getElementById('details-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');

        // --- API Base URL ---
        const API_BASE_URL = 'http://localhost:8000';

        // --- Functions ---

        /**
         * Calls the login API based on the openapi.json spec.
         * @param {string} username - The user's username.
         * @param {string} password - The user's password.
         * @returns {Promise<object>} - A promise that resolves with token data or rejects with an error.
         */
        async function loginApi(username, password) {
            console.log(`Attempting to log in user: ${username}`);
            // The API expects form data, so we use URLSearchParams
            const params = new URLSearchParams();
            params.append('username', username);
            params.append('password', password);

            const response = await fetch(`${API_BASE_URL}/api/v1/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-wWw-form-urlencoded',
                },
                body: params,
            });

            const data = await response.json();
            // If the response is not OK (e.g., 401, 400), throw an error with the detail message
            if (!response.ok) {
                throw new Error(data.detail || 'Login failed due to an unknown error.');
            }
            return data;
        }

        /**
         * Fetches user details from the /users/me endpoint.
         * @param {string} token - The JWT access token.
         * @returns {Promise<object>} - A promise that resolves with user data or rejects with an error.
         */
        async function fetchUserDetails(token) {
            console.log('Fetching user details with token...');
            const response = await fetch(`${API_BASE_URL}/api/v1/users/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });

            const data = await response.json();
             // If the response is not OK, throw an error with the detail message
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to fetch user details.');
            }
            return data;
        }

        /**
         * Displays the user details on the page.
         * @param {object} userData - The user data object.
         */
        function displayUserDetails(userData) {
            document.getElementById('user-full-name').textContent = userData.full_name || 'N/A';
            document.getElementById('user-username').textContent = userData.username || 'N/A';
            document.getElementById('user-phone').textContent = userData.phone_number || 'N/A';
            document.getElementById('user-role').textContent = userData.role || 'N/A';
            const statusElement = document.getElementById('user-status');
            if (userData.is_active) {
                statusElement.textContent = 'Active';
                statusElement.className = 'font-semibold text-green-600';
            } else {
                statusElement.textContent = 'Inactive';
                statusElement.className = 'font-semibold text-red-600';
            }
        }

        /**
         * Switches the view between login and details pages.
         * @param {string} page - The page to show ('login' or 'details').
         */
        function switchPage(page) {
            if (page === 'details') {
                loginPage.classList.add('hidden');
                detailsPage.classList.remove('hidden');
            } else {
                detailsPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
            }
        }


        /**
         * Handles the login process.
         * @param {Event} event - The form submission event.
         */
        async function handleLogin(event) {
            event.preventDefault();
            loginError.textContent = '';
            const username = loginForm.username.value;
            const password = loginForm.password.value;

            try {
                // Step 1: Call the login API
                const tokenData = await loginApi(username, password);

                // Step 2: Save the token to localStorage for persistence
                localStorage.setItem('accessToken', tokenData.access_token);

                // Step 3: Fetch user details with the new token
                const userData = await fetchUserDetails(tokenData.access_token);

                // Step 4: Display details and switch page
                displayUserDetails(userData);
                switchPage('details');

            } catch (error) {
                loginError.textContent = error.message;
                console.error('Login failed:', error);
            }
        }

        /**
         * Handles the logout process.
         */
        function handleLogout() {
            // Remove the token from storage
            localStorage.removeItem('accessToken');
            // Clear form fields
            loginForm.reset();
            loginError.textContent = '';
            // Switch back to the login page
            switchPage('login');
            console.log('User logged out.');
        }

        /**
         * Initializes the application on page load.
         */
        async function initializeApp() {
            const token = localStorage.getItem('accessToken');
            if (token) {
                console.log('Found existing token. Verifying...');
                try {
                    // If a token exists, try to fetch user data
                    const userData = await fetchUserDetails(token);
                    displayUserDetails(userData);
                    switchPage('details');
                } catch (error) {
                    // If token is invalid or expired, clear it and show login
                    console.error('Token validation failed:', error.message);
                    handleLogout();
                }
            } else {
                console.log('No token found. Showing login page.');
                switchPage('login');
            }
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);

        // --- App Initialization ---
        // Run the initialization function when the page is fully loaded.
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

